<!-- Modal de Login -->
<div id="loginModal" class="modal">
  <span class="close-modal" id="close-modal">&times;</span>

  <div class="modal-content">
    <!-- Header del Modal -->
    <div class="modal-header">
      <h2><span>üîê</span> Acceso al Sistema</h2>
      <p>IHP Reparaciones - Sistema Autom√°tico</p>
    </div>

    <!-- Body del Modal -->
    <div class="modal-body">
      <form id="loginForm">
        <div class="form-group">
          <label>üë§ Usuario</label>
          <input type="text" id="username" name="username" placeholder="Ingresa tu usuario" required>
          <small class="form-help">El sistema detectar√° autom√°ticamente tu rol</small>
        </div>

        <div class="form-group">
          <label>üîí Contrase√±a</label>
          <input type="password" id="password" name="password" placeholder="Ingresa tu contrase√±a" required>
        </div>

        <div class="form-options">
          <label>
            <input type="checkbox" name="remember">
            Recordarme
          </label>
          <a href="#" class="forgot-password">¬øOlvidaste tu contrase√±a?</a>
        </div>

        <div id="loginError">
          ‚ùå Usuario o contrase√±a incorrectos
        </div>

        <button type="submit" class="login-btn">
          <span>üöÄ</span> Iniciar Sesi√≥n Autom√°tico
        </button>
      </form>

      <div class="demo-credentials">
        <p><strong>Credenciales de prueba:</strong></p>
        <p>üëë <strong>Admin:</strong> admin / admin</p>
        <p>üîß <strong>T√©cnico 1:</strong> tecnico1 / tec123</p>
        <p>üîß <strong>T√©cnico 2:</strong> tecnico2 / tec456</p>
        <p>üë§ <strong>Cliente 1:</strong> carlos / cliente123</p>
        <p>üë§ <strong>Cliente 2:</strong> ana / cliente456</p>
      </div>
    </div>

    <!-- Footer del Modal -->
    <div class="modal-footer">
      <p>¬© 2026 IHP Reparaciones - Sistema Autom√°tico v2.0</p>
      <p><small>El rol se asigna autom√°ticamente seg√∫n el usuario</small></p>
    </div>
  </div>
</div>

<!-- Script actualizado -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('loginModal');
    const openBtn = document.getElementById('open-login-modal');
    const closeBtn = document.getElementById('close-modal');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    
    // Abrir modal
    if (openBtn) {
      openBtn.onclick = function() {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      };
    }
    
    // Cerrar modal
    function closeModal() {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
      loginForm.reset();
      loginError.style.display = 'none';
    }
    
    if (closeBtn) {
      closeBtn.onclick = closeModal;
    }
    
    // Cerrar al hacer click fuera del modal
    window.onclick = function(event) {
      if (event.target == modal) {
        closeModal();
      }
    }
    
    // Manejar env√≠o del formulario CON FETCH
    if (loginForm) {
      loginForm.onsubmit = async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        // Mostrar loader
        const submitBtn = loginForm.querySelector('.login-btn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span>‚è≥</span> Verificando...';
        submitBtn.disabled = true;
        
        // Enviar credenciales al servidor
        try {
          const response = await fetch('/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Login exitoso
            closeModal();
            showNotification(`‚úÖ Bienvenido ${data.user_name} (${data.role})`, 'success');
            
            // Redirigir autom√°ticamente seg√∫n el rol
            setTimeout(() => {
              window.location.href = data.redirect;
            }, 1500);
          } else {
            // Error en login
            loginError.textContent = data.message || '‚ùå Credenciales incorrectas';
            loginError.style.display = 'block';
            
            // Agitar el formulario
            loginForm.style.animation = 'shake 0.5s';
            setTimeout(() => {
              loginForm.style.animation = '';
            }, 500);
          }
        } catch (error) {
          console.error('Error:', error);
          loginError.textContent = '‚ùå Error de conexi√≥n al servidor';
          loginError.style.display = 'block';
        } finally {
          // Restaurar bot√≥n
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      };
    }
    
    // Funci√≥n para mostrar notificaciones
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.className = 'notification';
      notification.style.background = type === 'success' ? 'var(--granate)' : '#ff6b6b';
      notification.style.color = 'white';
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
  });
</script>